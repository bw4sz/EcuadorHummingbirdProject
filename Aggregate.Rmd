---
title: "AggregateData"
author: "Ben Weinstein"
date: "May 2, 2017"
output: html_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(taxize)
library(dplyr)
library(stringr)
library(gdata)
library(chron)
library(readxl)

basename="C:/Users/Ben/Dropbox/Ecuador hummingbird project/Public Folder/Data"
```

#Transect Data

```{r}
transect_files<-list.files(basename,recursive=TRUE,pattern="transect_",full.names=T)

#only xlsx files
transect_files<-transect_files[str_detect(transect_files,".xlsx")]

transect_xlsx<-lapply(transect_files,function(x){
  y<-read_xlsx(x)
  #turn waypoints to character for the moment
  y$waypoint<-as.character(y$waypoint)
  y$total_flowers<-as.character(y$total_flowers)
  
  return(y)
})

#Combine files
transect_data<-bind_rows(transect_xlsx)
#turn total flowers back to numeric
transect_data$total_flowers<-as.numeric(transect_data$total_flowers)

```

## Cleaning

```{r}
#Month and year column
transect_data$Month<-months(strptime(transect_data$date,"%d/%m/%Y"))
transect_data$Year<-years(strptime(transect_data$date,"%d/%m/%Y"))

#TODO taxize and name standardization

#revised name matching

#hummingbird name column needs to be standardized, NO CAPS for any column

transect_clean<-transect_data %>% select(date,Month,Year,site,plant_field_name,total_flowers,waypoint,height,hummingbird,comment)

```

## Divide into plant and hummingbird transects

```{r}
hummingbird_transects<-transect_clean %>% filter(!hummingbird=="")

#What's up with cambugan, alot of no total flower counts?
plant_transects<-transect_clean %>% filter(!plant_field_name=="") %>% filter(!is.na(total_flowers))
```

## Combine with gps data

## Write to file

```{r}
#plants
write.csv(hummingbird_transects,"C:/Users/Ben/Dropbox/Ecuador hummingbird project/Public Folder/Data/Cleaned/HummingbirdTransects.csv")

#write to shiny server
write.csv(hummingbird_transects,"HummingbirdData/HummingbirdTransects.xlsx")

#plants
write.csv(plant_transects,"C:/Users/Ben/Dropbox/Ecuador hummingbird project/Public Folder/Data/Cleaned/PlantTransects.csv")

#write to shiny server
write.csv(plant_transects,"HummingbirdData/PlantTransects.csv")
```

#Camera Data

```{r}
camera_files<-list.files(basename,recursive=TRUE,pattern="cameras",full.names = T)

#only xlsx files
camera_files<-camera_files[str_detect(camera_files,".xlsx")]

camera_xlsx<-lapply(camera_files,function(x){
  print(x)
  j<-read_xlsx(x)
  j$waypoint<-as.character(j$waypoint)
  j$card_id<-as.character(j$card_id)
  return(j)
})

camera_dat<-bind_rows(camera_xlsx)
```

## Cleaning

```{r}
#Month and year column
camera_dat$Month<-months(strptime(camera_dat$start_date,"%d/%m/%Y"))
camera_dat$Year<-years(strptime(camera_dat$start_date,"%d/%m/%Y"))

##need to standardize plant species to read from revised plant names

##TODO TAXIZE
```

## Combine with GPS data

## Write to file

```{r}
#write to dropbox
write.csv(camera_dat,"C:/Users/Ben/Dropbox/Ecuador hummingbird project/Public Folder/Data/Cleaned/Cameras.csv")

#write to shiny server
write.csv(camera_dat,"HummingbirdData/Cameras.csv")
```

#Interaction Data

```{r}
int_files<-list.files(basename,recursive=TRUE,pattern="observations",full.names = T)

#only xlsx files
int_files<-int_files[str_detect(int_files,".xlsx")]

int_data<-lapply(int_files,function(x){
  j<-read_xlsx(x)
  j$time<-as.character(j$time)
  j$filename<-as.character(j$filename)
  return(j)
})

int_data<-bind_rows(int_data)
```

## Cleaning

```{r}

#get site ID
int_data$waypoint

#for the cameras that don't match, look in comment field.

#taxize
unique(int_data$hummingbird)
```

## Combine with gps data

```{r}


```

## Write to file

```{r}
#write to dropbox
write.csv(int_data,"C:/Users/Ben/Dropbox/Ecuador hummingbird project/Public Folder/Data/Cleaned/Interactions.csv")

#write to shiny server
write.csv(int_data,"HummingbirdData/Interactions.csv")
```
