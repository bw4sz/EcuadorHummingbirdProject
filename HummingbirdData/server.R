library(shiny)
library(maptools)
library(dplyr)
library(htmltools)
library(ggplot2)

server <- function(input, output, session) {
  Sys.setlocale('LC_ALL','C') 
  
  #Site Map
  d<-read.csv("Sites.csv",row.names=1)
  d$Site<-rownames(d)
  m <- leaflet(d) %>% addTiles() %>% addMarkers(~long,~lat,popup=~Site)
  output$mymap <- renderLeaflet(m)
  
  #Transect Data
  transects<-read.csv("PlantTransects.csv",row.names=1)
  
  #How many transects by site
  mostc<-function(x){names(sort(table(x),decreasing=T))[1]}
  tran_table<-transects %>% group_by(site) %>% summarize(N=length(unique(date)),Species=length(unique(plant_field_name)),total_flowers=sum(total_flowers),Top_Plant=mostc(plant_field_name))
  
  #Plot of flower count over time
  output$tran_table<-renderTable(tran_table)
  
  #Phenology plots
  #month factor
  transects$Month<-factor(transects$Month,levels=month.name)
  phenology<-transects %>% group_by(site,Month,Year) %>% summarize(total_flowers=sum(total_flowers))
  output$phenology<-renderPlot({
    p<-ggplot(data=phenology,aes(x=Month,y=total_flowers,col=site)) + facet_wrap(~Year) + geom_point() + geom_line(aes(group=site)) + labs(y="Flowers",col="Site")
    print(p)
  },height=350,width=750)
  
  #plant elevation ranges
  #screen plants with more than 20 records
  common_plants<-transects %>% group_by(plant_field_name) %>% summarise(n=n()) %>% filter(n>20)
  common_totals<-transects %>% filter(!is.na(elevation)) %>% filter(plant_field_name %in% common_plants$plant_field_name)
  
  #lowest to highest elevation factor order
  plant_ord<-common_totals  %>% drop.levels() %>% group_by(plant_field_name) %>% summarize(e=mean(as.numeric(elevation))) %>% arrange(e) %>% .$plant_field_name
  common_totals$plant_field_name <- factor(common_totals$plant_field_name,levels=plant_ord)
  plant_elev<-ggplot(common_totals,aes(x=plant_field_name,y=as.numeric(elevation))) + geom_boxplot(aes(fill=site)) + coord_flip() + theme_bw() + labs(x="Elevation(m)",y="Species",fill="Site") 
  output$plant_elev<-renderPlot(plant_elev)
  
  #Camera Data
  camera_dat<-read.csv("Cameras.csv")
  
  ## summary table
  cam_table<-camera_dat %>% group_by(site) %>% summarize(n=n(),plant_species=length(unique(plant_field_name)))
  output$cam_table<-renderTable(cam_table)
  
  #Interaction Data
  int_data<-read.csv("Interactions.csv")
  
  #Summary Table
  int_table<-int_data %>% group_by(site) %>% summarize(Observations=n(),hummingbird_species=length(unique(hummingbird)),plant_species=length(unique(plant_field_name)))
  output$int_table<-renderTable(int_table)
  
  #interaction table
  net_table<-int_data %>% group_by(plant_field_name,hummingbird) %>% summarize(n=n()) %>% arrange()
  net_table<-droplevels(net_table)
  hum_ord<-net_table %>% group_by(hummingbird) %>% summarize(n=n()) %>% arrange(n) %>% .$hummingbird
  plant_ord<-net_table %>% group_by(plant_field_name) %>% summarize(n=n()) %>% arrange(desc(n)) %>% .$plant_field_name
  
  net_table$hummingbird<-factor(net_table$hummingbird,levels=hum_ord)
  net_table$plant_field_name<-factor(net_table$plant_field_name,levels = plant_ord)
  int_plot<-ggplot(net_table,aes(x=plant_field_name,y=hummingbird,fill=n)) + geom_tile() + labs(y="Hummingbird",x="Plant",fill="Observations") + theme_bw() + theme(axis.text.x=element_text(angle=-90)) + scale_fill_continuous(low="blue",high="red")
  output$int_plot<-renderPlot(int_plot,height=600,width=900)
  
  ##plant map  
  m <- leaflet(d) %>% addTiles() %>% addMarkers(~long,~lat,popup=~Site)
  output$mymap <- renderLeaflet(m)
  
  
  ##Bird map
  
  ##Interactions by site
  
  ## Across sites
}
